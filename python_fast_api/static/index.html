<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Image Analysis Upload</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 0; padding: 0; }
      .container { max-width: 680px; margin: 0 auto; padding: 24px; }
      h1 { font-size: 1.5rem; margin: 0 0 12px; }
      p { margin: 0 0 16px; }
      form { display: grid; gap: 12px; }
      .card { border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 16px; backdrop-filter: saturate(180%) blur(10px); }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      button { appearance: none; border: none; background: #2563eb; color: white; padding: 12px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; }
      button[disabled] { opacity: 0.6; cursor: not-allowed; }
      .output { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 0.9rem; }
      .preview { max-width: 100%; border-radius: 8px; display: none; }
      label { font-weight: 600; }
      input[type="file"] { padding: 8px; border: 1px solid rgba(0,0,0,0.15); border-radius: 10px; background: rgba(0,0,0,0.04); }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Upload an Image</h1>
      <p>Select a photo from your device or use your camera, then submit to analyze. Ensure the image is a png, jpg, or jpeg image</p>
      <div class="card">
        <form id="upload-form">
          <div class="row">
            <label for="file">Choose image</label>
            <input id="file" name="file" type="file" accept="image/*" capture="environment" />
          </div>
          <img id="preview" class="preview" alt="Preview" />
          <div class="row">
            <button id="submit" type="submit">Analyze</button>
            <button id="clear" type="button">Clear</button>
          </div>
        </form>
      </div>
      <div class="card">
        <div id="output" class="output">Response will appear here.</div>
        <img id="result-image" class="preview" alt="Result" style="margin-top:12px; display:none;" />
        <div class="row" id="download-row" style="display:none; margin-top:8px;">
          <a id="download-link" download="output.jpg">Download result</a>
        </div>
      </div>
    </div>
    <script>
      const form = document.getElementById('upload-form');
      const fileInput = document.getElementById('file');
      const output = document.getElementById('output');
      const submitBtn = document.getElementById('submit');
      const clearBtn = document.getElementById('clear');
      const preview = document.getElementById('preview');

      fileInput.addEventListener('change', () => {
        const file = fileInput.files && fileInput.files[0];
        if (file) {
          const url = URL.createObjectURL(file);
          preview.src = url;
          preview.style.display = 'block';
        } else {
          preview.removeAttribute('src');
          preview.style.display = 'none';
        }
      });

      clearBtn.addEventListener('click', () => {
        fileInput.value = '';
        preview.removeAttribute('src');
        preview.style.display = 'none';
        output.textContent = 'Response will appear here.';
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          output.textContent = 'Please choose an image first.';
          return;
        }
        submitBtn.disabled = true;
        output.textContent = 'Uploadingâ€¦';
        try {
          const data = new FormData();
          data.append('file', file);
          const res = await fetch('/analyze_image', { method: 'POST', body: data });
          const contentType = res.headers.get('content-type') || '';
          if (contentType.includes('image/')) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            output.textContent = 'Analysis complete. See result image below.';
            const resultImg = document.getElementById('result-image');
            const dlRow = document.getElementById('download-row');
            const dlLink = document.getElementById('download-link');
            resultImg.src = url;
            resultImg.style.display = 'block';
            dlRow.style.display = 'flex';
            dlLink.href = url;
          } else {
            const text = await res.text();
            output.textContent = text;
            document.getElementById('result-image').style.display = 'none';
            document.getElementById('download-row').style.display = 'none';
          }
        } catch (err) {
          output.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
  </html>


